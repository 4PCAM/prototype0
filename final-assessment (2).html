<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Assessment Report - 4-PCAM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .report-header {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
        }

        .report-header h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .patient-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #74b9ff;
        }

        .patient-summary h4 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .patient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .assessment-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .pillar-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .pillar-header {
            padding: 20px;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .pillar-1 { background: linear-gradient(135deg, #ff7675, #d63031); }
        .pillar-2 { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .pillar-3 { background: linear-gradient(135deg, #a8e6a3, #00b894); }
        .pillar-4 { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); }

        .pillar-content {
            padding: 25px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .score-card {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .score-card:hover {
            transform: translateY(-2px);
        }

        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .score-label {
            font-size: 12px;
            color: #2d3436;
            margin-top: 5px;
        }

        .symptoms-section {
            margin-top: 20px;
            background: #f1f2f6;
            padding: 20px;
            border-radius: 10px;
        }

        .symptoms-section h5 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .symptom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .symptom-tag {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .severity-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin: 5px;
            font-size: 13px;
        }

        .normal { background: #00b894; color: white; }
        .mild { background: #fdcb6e; color: #2d3436; }
        .moderate { background: #e17055; color: white; }
        .severe { background: #d63031; color: white; }

        .clinical-summary {
            background: #e8f4fd;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border-left: 5px solid #74b9ff;
        }

        .clinical-summary h4 {
            color: #2d3436;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .summary-card h5 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .recommendations {
            background: #d4edda;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border-left: 5px solid #00b894;
        }

        .recommendations h4 {
            color: #155724;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00b894;
            font-size: 14px;
        }

        .actions-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 150px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            color: #2d3436;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: none;
            }
            
            .actions-section {
                display: none;
            }
            
            .pillar-section {
                break-inside: avoid;
                margin-bottom: 20px;
            }
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .assessment-sections {
                grid-template-columns: 1fr;
            }
            
            .actions-section {
                flex-direction: column;
                align-items: center;
            }
            
            .patient-grid {
                grid-template-columns: 1fr;
            }
            
            .score-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-content">
            <h3>Generating PDF Report...</h3>
            <p>Please wait while we create your comprehensive assessment report.</p>
        </div>
    </div>

    <div class="container" id="report-container">
        <div class="header">
            <h1>📋 COMPREHENSIVE ASSESSMENT REPORT</h1>
            <p><strong>4-Pillar Clinical Assessment Model (4-PCAM)</strong></p>
            <p><strong>Developer:</strong> Dr. Smitrajsinh Jadeja, Dr. Anirudh Bhatt, Dr. Yogesh Valaki, Dr. Diksha Kanani</p>
            <p><strong>Guided By:</strong> Dr. Prakash Kumbar</p>
        </div>

        <div class="content">
            <div class="report-header">
                <h3>📊 FINAL ASSESSMENT REPORT</h3>
                <p>Complete 4-Pillar Ayurvedic Clinical Assessment</p>
                <div id="report-date"></div>
            </div>

            <div class="patient-summary">
                <h4>👤 Patient Information</h4>
                <div class="patient-grid" id="patient-info">
                    <!-- Patient info will be loaded here -->
                </div>
            </div>

            <div class="assessment-sections">
                <!-- PILLAR 1: AGNI -->
                <div class="pillar-section">
                    <div class="pillar-header pillar-1">
                        <h4>🔥 PILLAR 1: AGNI DUSTI ASSESSMENT</h4>
                    </div>
                    <div class="pillar-content">
                        <div class="score-grid" id="agni-scores">
                            <!-- Agni scores will be loaded here -->
                        </div>
                        <div id="agni-assessment">
                            <!-- Agni assessment results will be loaded here -->
                        </div>
                        <div class="symptoms-section" id="agni-symptoms">
                            <h5>🔍 Selected Agni Symptoms</h5>
                            <div class="symptom-tags" id="agni-symptom-tags">
                                <!-- Agni symptoms will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PILLAR 2: DOSHA -->
                <div class="pillar-section">
                    <div class="pillar-header pillar-2">
                        <h4>⚖️ PILLAR 2: DOSHA DUSTI ASSESSMENT</h4>
                    </div>
                    <div class="pillar-content">
                        <div class="score-grid" id="dosha-scores">
                            <!-- Dosha scores will be loaded here -->
                        </div>
                        <div id="dosha-assessment">
                            <!-- Dosha assessment results will be loaded here -->
                        </div>
                        <div class="symptoms-section" id="dosha-symptoms">
                            <h5>🔍 Selected Dosha Symptoms</h5>
                            <div id="dosha-symptom-details">
                                <!-- Dosha symptoms will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PILLAR 3: DHATU -->
                <div class="pillar-section">
                    <div class="pillar-header pillar-3">
                        <h4>🧬 PILLAR 3: DHATU DUSTI ASSESSMENT</h4>
                    </div>
                    <div class="pillar-content">
                        <div id="dhatu-assessment">
                            <!-- Dhatu assessment results will be loaded here -->
                        </div>
                        <div class="symptoms-section" id="dhatu-symptoms">
                            <h5>🔍 Selected Dhatu Symptoms</h5>
                            <div id="dhatu-symptom-details">
                                <!-- Dhatu symptoms will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PILLAR 4: SROTAS -->
                <div class="pillar-section">
                    <div class="pillar-header pillar-4">
                        <h4>🌊 PILLAR 4: SROTO DUSTI ASSESSMENT</h4>
                    </div>
                    <div class="pillar-content">
                        <div id="srotas-assessment">
                            <!-- Srotas assessment results will be loaded here -->
                        </div>
                        <div class="symptoms-section" id="srotas-symptoms">
                            <h5>🔍 Selected Srotas Symptoms</h5>
                            <div id="srotas-symptom-details">
                                <!-- Srotas symptoms will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="clinical-summary">
                <h4>🏥 Clinical Summary & Analysis</h4>
                <div class="summary-grid">
                    <div class="summary-card">
                        <h5>🔥 Agni Status</h5>
                        <div id="agni-summary">
                            <!-- Agni summary will be loaded here -->
                        </div>
                    </div>
                    <div class="summary-card">
                        <h5>⚖️ Dosha Dominance</h5>
                        <div id="dosha-summary">
                            <!-- Dosha summary will be loaded here -->
                        </div>
                    </div>
                    <div class="summary-card">
                        <h5>🧬 Dhatu Involvement</h5>
                        <div id="dhatu-summary">
                            <!-- Dhatu summary will be loaded here -->
                        </div>
                    </div>
                    <div class="summary-card">
                        <h5>🌊 Srotas Dysfunction</h5>
                        <div id="srotas-summary">
                            <!-- Srotas summary will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="recommendations">
                <h4>💡 Clinical Recommendations</h4>
                <ul class="recommendation-list" id="recommendations-list">
                    <!-- Recommendations will be generated here -->
                </ul>
            </div>

            <div class="actions-section">
                <button class="btn btn-primary" onclick="exportToPDF()">📄 Export as PDF</button>
                <button class="btn btn-warning" onclick="printReport()">🖨️ Print Report</button>
                <button class="btn btn-secondary" onclick="saveReport()">💾 Save Data</button>
                <button class="btn btn-danger" onclick="resetAllData()">🔄 Reset All</button>
                <a href="patient-info.html" class="btn btn-secondary">← New Assessment</a>
            </div>
        </div>
    </div>

    <script>
        let combinedData = {};

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessmentData();
            generateReport();
        });

        function loadAssessmentData() {
            const saved = localStorage.getItem('4pcam_combined_data');
            if (saved) {
                try {
                    combinedData = JSON.parse(saved);
                    
                    // Verify all assessments are completed
                    if (!combinedData.patient || !combinedData.agni || !combinedData.dosha || 
                        !combinedData.dhatu || !combinedData.srotas) {
                        alert('Incomplete assessment data found. Please complete all 4 pillars.');
                        window.location.href = 'patient-info.html';
                        return;
                    }
                    
                } catch (e) {
                    alert('Error loading assessment data. Please start over.');
                    window.location.href = 'patient-info.html';
                    return;
                }
            } else {
                alert('No assessment data found. Please complete the 4-pillar assessment first.');
                window.location.href = 'patient-info.html';
                return;
            }
        }

        function generateReport() {
            // Set report date
            const now = new Date();
            document.getElementById('report-date').innerHTML = `
                <p><strong>Report Generated:</strong> ${now.toLocaleDateString()} ${now.toLocaleTimeString()}</p>
            `;

            // Load patient information
            loadPatientInfo();

            // Load each pillar assessment
            loadAgniAssessment();
            loadDoshaAssessment();
            loadDhatuAssessment();
            loadSrotasAssessment();

            // Generate clinical summary
            generateClinicalSummary();

            // Generate recommendations
            generateRecommendations();
        }

        function loadPatientInfo() {
            const patient = combinedData.patient;
            const infoEl = document.getElementById('patient-info');
            
            infoEl.innerHTML = `
                <div><strong>Name:</strong> ${patient.name || 'N/A'}</div>
                <div><strong>Age/Sex:</strong> ${patient.ageSex || 'N/A'}</div>
                <div><strong>Patient ID:</strong> ${patient.patientId || 'N/A'}</div>
                <div><strong>Date of Assessment:</strong> ${patient.assessmentDate || 'N/A'}</div>
                <div><strong>Referred By:</strong> ${patient.referredBy || 'N/A'}</div>
                <div style="grid-column: 1/-1;"><strong>Chief Complaints:</strong> ${patient.complaints || 'N/A'}</div>
                <div style="grid-column: 1/-1;"><strong>Past History:</strong> ${patient.pastHistory || 'Not specified'}</div>
                <div style="grid-column: 1/-1;"><strong>Additional Points:</strong> ${patient.additionalPoints || 'Not specified'}</div>
            `;
        }

        function loadAgniAssessment() {
            const agni = combinedData.agni;
            const scoresEl = document.getElementById('agni-scores');
            const assessmentEl = document.getElementById('agni-assessment');
            const symptomsEl = document.getElementById('agni-symptom-tags');

            // Load scores
            scoresEl.innerHTML = `
                <div class="score-card">
                    <div class="score-value">${agni.vishama || 0}</div>
                    <div class="score-label">Viṣama Agni</div>
                </div>
                <div class="score-card">
                    <div class="score-value">${agni.tikshna || 0}</div>
                    <div class="score-label">Tīkṣṇa Agni</div>
                </div>
                <div class="score-card">
                    <div class="score-value">${agni.manda || 0}</div>
                    <div class="score-label">Manda Agni</div>
                </div>
                <div class="score-card">
                    <div class="score-value">${agni.sama || 0}</div>
                    <div class="score-label">Sama Agni</div>
                </div>
            `;

            // Calculate assessment
            const totalDusti = (agni.vishama || 0) + (agni.tikshna || 0) + (agni.manda || 0);
            let severity, severityClass;

            if (totalDusti === 0 && agni.sama > 0) {
                severity = 'SAMA AGNI (Balanced)';
                severityClass = 'normal';
            } else if (totalDusti <= 4) {
                severity = 'MILD AGNI DUSTI';
                severityClass = 'mild';
            } else if (totalDusti <= 6) {
                severity = 'MODERATE AGNI DUSTI';
                severityClass = 'moderate';
            } else {
                severity = 'SEVERE AGNI DUSTI';
                severityClass = 'severe';
            }

            assessmentEl.innerHTML = `
                <p><strong>Total Dusti Score:</strong> ${totalDusti}/8</p>
                <p><strong>Assessment:</strong> <span class="severity-indicator ${severityClass}">${severity}</span></p>
            `;

            // Load symptoms
            const symptoms = Object.values(agni.selectedSymptoms || {});
            if (symptoms.length > 0) {
                symptomsEl.innerHTML = symptoms.map(s => 
                    `<span class="symptom-tag">${s.parameter}: ${s.symptom}</span>`
                ).join('');
            } else {
                symptomsEl.innerHTML = '<span class="symptom-tag">No specific symptoms recorded</span>';
            }
        }

        function loadDoshaAssessment() {
            const dosha = combinedData.dosha;
            const scoresEl = document.getElementById('dosha-scores');
            const assessmentEl = document.getElementById('dosha-assessment');
            const symptomsEl = document.getElementById('dosha-symptom-details');

            // Load scores
            scoresEl.innerHTML = `
                <div class="score-card">
                    <div class="score-value">${dosha.vata || 0}</div>
                    <div class="score-label">Vata Dushti</div>
                </div>
                <div class="score-card">
                    <div class="score-value">${dosha.pitta || 0}</div>
                    <div class="score-label">Pitta Dushti</div>
                </div>
                <div class="score-card">
                    <div class="score-value">${dosha.kapha || 0}</div>
                    <div class="score-label">Kapha Dushti</div>
                </div>
            `;

            // Determine dominant dosha
            const vScore = dosha.vata || 0;
            const pScore = dosha.pitta || 0;
            const kScore = dosha.kapha || 0;
            const maxScore = Math.max(vScore, pScore, kScore);

            let dominant = 'Balanced';
            if (maxScore === vScore && vScore > 0) dominant = 'Vata Dūṣṭi Dominant';
            else if (maxScore === pScore && pScore > 0) dominant = 'Pitta Dūṣṭi Dominant';
            else if (maxScore === kScore && kScore > 0) dominant = 'Kapha Dūṣṭi Dominant';

            assessmentEl.innerHTML = `
                <p><strong>Dominant Pattern:</strong> ${dominant}</p>
                <p><strong>Vata Status:</strong> <span class="severity-indicator ${getDoshaSeverityClass(vScore)}">${getDoshaSeverityText(vScore)}</span></p>
                <p><strong>Pitta Status:</strong> <span class="severity-indicator ${getDoshaSeverityClass(pScore)}">${getDoshaSeverityText(pScore)}</span></p>
                <p><strong>Kapha Status:</strong> <span class="severity-indicator ${getDoshaSeverityClass(kScore)}">${getDoshaSeverityText(kScore)}</span></p>
            `;

            // Load symptoms
            const selectedSymptoms = dosha.selectedSymptoms || {};
            let symptomsHTML = '';
            
            Object.keys(selectedSymptoms).forEach(doshaType => {
                const symptoms = selectedSymptoms[doshaType] || [];
                if (symptoms.length > 0) {
                    symptomsHTML += `
                        <div style="margin-bottom: 15px;">
                            <strong>${doshaType.charAt(0).toUpperCase() + doshaType.slice(1)} Symptoms:</strong>
                            <div class="symptom-tags" style="margin-top: 8px;">
                                ${symptoms.map(s => 
                                    `<span class="symptom-tag">${s.parameter}: ${s.symptom} (${s.severityText})</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            symptomsEl.innerHTML = symptomsHTML || '<p>No specific dosha symptoms recorded</p>';
        }

        function loadDhatuAssessment() {
            const dhatu = combinedData.dhatu;
            const assessmentEl = document.getElementById('dhatu-assessment');
            const symptomsEl = document.getElementById('dhatu-symptom-details');

            // Calculate overall dhatu scores
            let totalKshaya = 0;
            let totalVriddhi = 0;
            let dhatuHTML = '<div class="score-grid">';

            Object.keys(dhatu.scores || {}).forEach(dhatuName => {
                const scores = dhatu.scores[dhatuName];
                totalKshaya += scores.kshaya || 0;
                totalVriddhi += scores.vriddhi || 0;
                
                dhatuHTML += `
                    <div class="score-card">
                        <div class="score-value">${(scores.kshaya || 0) + (scores.vriddhi || 0)}</div>
                        <div class="score-label">${dhatuName.charAt(0).toUpperCase() + dhatuName.slice(1)}</div>
                    </div>
                `;
            });

            dhatuHTML += '</div>';

            const totalDhatuScore = totalKshaya + totalVriddhi;
            let severity = 'normal';
            let severityText = 'No significant dhatu dushti';
            
            if (totalDhatuScore >= 1 && totalDhatuScore <= 10) {
                severity = 'mild';
                severityText = 'Mild dhatu imbalance';
            } else if (totalDhatuScore >= 11 && totalDhatuScore <= 20) {
                severity = 'moderate';
                severityText = 'Moderate dhatu dysfunction';
            } else if (totalDhatuScore >= 21) {
                severity = 'severe';
                severityText = 'Severe dhatu pathology';
            }

            dhatuHTML += `
                <p><strong>Total Dhatu Score:</strong> ${totalDhatuScore} (Kshaya: ${totalKshaya}, Vriddhi: ${totalVriddhi})</p>
                <p><strong>Assessment:</strong> <span class="severity-indicator ${severity}">${severityText}</span></p>
            `;

            assessmentEl.innerHTML = dhatuHTML;

            // Load symptoms
            const selectedSymptoms = dhatu.selectedSymptoms || {};
            let symptomsHTML = '';
            
            Object.keys(selectedSymptoms).forEach(dhatuName => {
                const dhatuSymptoms = selectedSymptoms[dhatuName];
                const kshayaSymptoms = dhatuSymptoms.kshaya || [];
                const vriddhiSymptoms = dhatuSymptoms.vriddhi || [];
                
                if (kshayaSymptoms.length > 0 || vriddhiSymptoms.length > 0) {
                    symptomsHTML += `
                        <div style="margin-bottom: 15px;">
                            <strong>${dhatuName.charAt(0).toUpperCase() + dhatuName.slice(1)} Dhatu:</strong>
                            ${kshayaSymptoms.length > 0 ? `
                                <div style="margin-top: 5px;"><em>Kshaya (Depletion):</em></div>
                                <div class="symptom-tags" style="margin-top: 5px;">
                                    ${kshayaSymptoms.map(s => `<span class="symptom-tag">${s.symptom} (${s.severity})</span>`).join('')}
                                </div>
                            ` : ''}
                            ${vriddhiSymptoms.length > 0 ? `
                                <div style="margin-top: 5px;"><em>Vriddhi (Excess):</em></div>
                                <div class="symptom-tags" style="margin-top: 5px;">
                                    ${vriddhiSymptoms.map(s => `<span class="symptom-tag">${s.symptom} (${s.severity})</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });

            symptomsEl.innerHTML = symptomsHTML || '<p>No specific dhatu symptoms recorded</p>';
        }

        function loadSrotasAssessment() {
            const srotas = combinedData.srotas;
            const assessmentEl = document.getElementById('srotas-assessment');
            const symptomsEl = document.getElementById('srotas-symptom-details');

            // Calculate overall srotas scores
            let totalScore = 0;
            let srotasHTML = '<div class="score-grid">';

            const srotasNames = {
                annavaha: 'Annavaha',
                rasavaha: 'Rasavaha',
                raktavaha: 'Raktavaha',
                mamsavaha: 'Mamsavaha',
                medavaha: 'Medavaha',
                asthivaha: 'Asthivaha',
                majjavaha: 'Majjavaha',
                shukravaha: 'Shukravaha',
                mutravaha: 'Mutravaha'
            };

            Object.keys(srotas.scores || {}).forEach(srotasName => {
                const score = srotas.scores[srotasName] || 0;
                totalScore += score;
                
                srotasHTML += `
                    <div class="score-card">
                        <div class="score-value">${score}</div>
                        <div class="score-label">${srotasNames[srotasName]}</div>
                    </div>
                `;
            });

            srotasHTML += '</div>';

            let severity = 'normal';
            let severityText = 'No significant srotas dysfunction';
            
            if (totalScore >= 1 && totalScore <= 10) {
                severity = 'mild';
                severityText = 'Mild srotas dysfunction';
            } else if (totalScore >= 11 && totalScore <= 20) {
                severity = 'moderate';
                severityText = 'Moderate srotas blockage';
            } else if (totalScore >= 21) {
                severity = 'severe';
                severityText = 'Severe srotas pathology';
            }

            srotasHTML += `
                <p><strong>Total Srotas Score:</strong> ${totalScore}</p>
                <p><strong>Assessment:</strong> <span class="severity-indicator ${severity}">${severityText}</span></p>
            `;

            assessmentEl.innerHTML = srotasHTML;

            // Load symptoms
            const selectedSymptoms = srotas.selectedSymptoms || {};
            let symptomsHTML = '';
            
            Object.keys(selectedSymptoms).forEach(srotasName => {
                const symptoms = selectedSymptoms[srotasName] || [];
                if (symptoms.length > 0) {
                    symptomsHTML += `
                        <div style="margin-bottom: 15px;">
                            <strong>${srotasNames[srotasName]} Srotas:</strong>
                            <div class="symptom-tags" style="margin-top: 8px;">
                                ${symptoms.map(s => `<span class="symptom-tag">${s.symptom} (${s.severity})</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            symptomsEl.innerHTML = symptomsHTML || '<p>No specific srotas symptoms recorded</p>';
        }

        function generateClinicalSummary() {
            const agni = combinedData.agni;
            const dosha = combinedData.dosha;
            const dhatu = combinedData.dhatu;
            const srotas = combinedData.srotas;

            // Agni Summary
            const agniTotal = (agni.vishama || 0) + (agni.tikshna || 0) + (agni.manda || 0);
            let agniStatus = 'Sama Agni (Optimal)';
            if (agniTotal > 0) {
                if (agniTotal <= 4) agniStatus = 'Mild Agni Dusti';
                else if (agniTotal <= 6) agniStatus = 'Moderate Agni Dusti';
                else agniStatus = 'Severe Agni Dusti';
            }
            document.getElementById('agni-summary').innerHTML = `
                <p><strong>Status:</strong> ${agniStatus}</p>
                <p><strong>Score:</strong> ${agniTotal}/8</p>
                <p><strong>Impact:</strong> ${getAgniImpact(agniTotal)}</p>
            `;

            // Dosha Summary
            const vScore = dosha.vata || 0;
            const pScore = dosha.pitta || 0;
            const kScore = dosha.kapha || 0;
            const maxScore = Math.max(vScore, pScore, kScore);
            
            let dominantDosha = 'Balanced State';
            if (maxScore === vScore && vScore > 0) dominantDosha = `Vata Dushti (${vScore})`;
            else if (maxScore === pScore && pScore > 0) dominantDosha = `Pitta Dushti (${pScore})`;
            else if (maxScore === kScore && kScore > 0) dominantDosha = `Kapha Dushti (${kScore})`;
            
            document.getElementById('dosha-summary').innerHTML = `
                <p><strong>Pattern:</strong> ${dominantDosha}</p>
                <p><strong>Total Score:</strong> ${vScore + pScore + kScore}</p>
                <p><strong>Constitution:</strong> ${getDoshaConstitution(vScore, pScore, kScore)}</p>
            `;

            // Dhatu Summary
            const dhatuScores = dhatu.scores || {};
            const totalDhatuSymptoms = Object.values(dhatu.selectedSymptoms || {}).reduce((total, d) => {
                return total + (d.kshaya ? d.kshaya.length : 0) + (d.vriddhi ? d.vriddhi.length : 0);
            }, 0);
            
            document.getElementById('dhatu-summary').innerHTML = `
                <p><strong>Affected Dhatus:</strong> ${Object.keys(dhatuScores).filter(d => 
                    (dhatuScores[d].kshaya || 0) + (dhatuScores[d].vriddhi || 0) > 0
                ).length}/7</p>
                <p><strong>Total Symptoms:</strong> ${totalDhatuSymptoms}</p>
                <p><strong>Priority:</strong> ${getDhatuPriority(dhatuScores)}</p>
            `;

            // Srotas Summary
            const srotasScores = srotas.scores || {};
            const totalSrotasScore = Object.values(srotasScores).reduce((total, score) => total + score, 0);
            const affectedSrotas = Object.keys(srotasScores).filter(s => srotasScores[s] > 0).length;
            
            document.getElementById('srotas-summary').innerHTML = `
                <p><strong>Affected Channels:</strong> ${affectedSrotas}/9</p>
                <p><strong>Total Score:</strong> ${totalSrotasScore}</p>
                <p><strong>Severity:</strong> ${getSrotasSeverity(totalSrotasScore)}</p>
            `;
        }

        function generateRecommendations() {
            const recommendations = [];
            const agni = combinedData.agni;
            const dosha = combinedData.dosha;
            const dhatu = combinedData.dhatu;
            const srotas = combinedData.srotas;

            // Agni recommendations
            const agniTotal = (agni.vishama || 0) + (agni.tikshna || 0) + (agni.manda || 0);
            if (agniTotal > 0) {
                if (agni.vishama > 0) {
                    recommendations.push("🔥 Vishama Agni: Regular meal timings, warm cooked foods, avoid irregular eating patterns");
                }
                if (agni.tikshna > 0) {
                    recommendations.push("🔥 Tikshna Agni: Cooling foods, avoid spicy and acidic foods, regular moderate meals");
                }
                if (agni.manda > 0) {
                    recommendations.push("🔥 Manda Agni: Light digestible foods, warm spices, avoid heavy cold foods, regular exercise");
                }
            } else {
                recommendations.push("✅ Maintain current balanced digestive practices");
            }

            // Dosha recommendations
            const vScore = dosha.vata || 0;
            const pScore = dosha.pitta || 0;
            const kScore = dosha.kapha || 0;

            if (vScore > 0) {
                recommendations.push("💨 Vata Pacification: Oil massage, warm foods, regular routine, stress management techniques");
            }
            if (pScore > 0) {
                recommendations.push("🔥 Pitta Pacification: Cooling foods, moderate exercise, avoid excessive heat and stress");
            }
            if (kScore > 0) {
                recommendations.push("🌊 Kapha Pacification: Light foods, vigorous exercise, avoid heavy cold foods, maintain active lifestyle");
            }

            // Dhatu recommendations
            const affectedDhatus = Object.keys(dhatu.scores || {}).filter(d => 
                (dhatu.scores[d].kshaya || 0) + (dhatu.scores[d].vriddhi || 0) > 0
            );

            if (affectedDhatus.length > 0) {
                recommendations.push("🧬 Dhatu Support: Nutritive diet, appropriate rasayana therapy, lifestyle modifications for tissue health");
                recommendations.push("💪 Tissue Regeneration: Consider panchakarma procedures for deep tissue cleansing and rejuvenation");
            }

            // Srotas recommendations
            const totalSrotasScore = Object.values(srotas.scores || {}).reduce((total, score) => total + score, 0);
            if (totalSrotasScore > 0) {
                recommendations.push("🌊 Channel Clearance: Detoxification procedures, appropriate exercise, pranayama practices");
                recommendations.push("🧘 Lifestyle: Yoga, meditation, stress reduction techniques for optimal channel function");
            }

            // General recommendations
            recommendations.push("📋 Follow-up: Regular monitoring and reassessment recommended every 3-6 months");
            recommendations.push("👨‍⚕️ Professional Care: Consult qualified Ayurvedic physician for personalized treatment protocol");

            const listEl = document.getElementById('recommendations-list');
            listEl.innerHTML = recommendations.map(rec => 
                `<li class="recommendation-item">${rec}</li>`
            ).join('');
        }

        // Helper functions for assessment
        function getDoshaSeverityClass(score) {
            if (score <= 4) return 'normal';
            if (score <= 9) return 'mild';
            if (score <= 14) return 'moderate';
            return 'severe';
        }

        function getDoshaSeverityText(score) {
            if (score <= 4) return 'No significant dushti';
            if (score <= 9) return 'Mild dushti';
            if (score <= 14) return 'Moderate dushti';
            return 'Severe dushti';
        }

        function getAgniImpact(score) {
            if (score === 0) return 'Optimal digestive capacity';
            if (score <= 4) return 'Minor digestive irregularities';
            if (score <= 6) return 'Significant digestive dysfunction';
            return 'Severe digestive pathology requiring immediate attention';
        }

        function getDoshaConstitution(vata, pitta, kapha) {
            const scores = [vata, pitta, kapha];
            const names = ['Vata', 'Pitta', 'Kapha'];
            const dominant = [];
            const max = Math.max(...scores);
            
            scores.forEach((score, i) => {
                if (score === max && score > 0) dominant.push(names[i]);
            });
            
            if (dominant.length === 0) return 'Balanced Constitution';
            if (dominant.length === 1) return `${dominant[0]} Predominant`;
            return `${dominant.join('-')} Mixed Type`;
        }

        function getDhatuPriority(scores) {
            let maxScore = 0;
            let priority = 'All dhatus balanced';
            
            Object.keys(scores).forEach(dhatu => {
                const total = (scores[dhatu].kshaya || 0) + (scores[dhatu].vriddhi || 0);
                if (total > maxScore) {
                    maxScore = total;
                    priority = `${dhatu.charAt(0).toUpperCase() + dhatu.slice(1)} dhatu requires attention`;
                }
            });
            
            return priority;
        }

        function getSrotasSeverity(score) {
            if (score === 0) return 'All channels functioning optimally';
            if (score <= 10) return 'Mild channel dysfunction';
            if (score <= 20) return 'Moderate channel blockage';
            return 'Severe channel pathology';
        }

        // Export and action functions
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            
            if (!jsPDF) {
                alert('PDF library not loaded. Please try again.');
                return;
            }

            document.getElementById('loading').style.display = 'flex';
            
            try {
                // Hide action buttons temporarily
                const actionsSection = document.querySelector('.actions-section');
                actionsSection.style.display = 'none';
                
                // Create PDF
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Use html2canvas to convert content to image
                const canvas = await html2canvas(document.getElementById('report-container'), {
                    scale: 1.5,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: 1200
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.7);
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Generate filename
                const patientName = combinedData.patient.name || 'Patient';
                const date = new Date().toISOString().split('T')[0];
                const filename = `${patientName.replace(/\s+/g, '_')}_4PCAM_Report_${date}.pdf`;

                // Save the PDF
                pdf.save(filename);
                
                // Show action buttons again
                actionsSection.style.display = 'flex';
                
                alert('PDF report generated successfully!');
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('Failed to generate PDF. Please try printing instead.');
                // Show action buttons again
                document.querySelector('.actions-section').style.display = 'flex';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function printReport() {
            // Hide action buttons for printing
            const actionsSection = document.querySelector('.actions-section');
            actionsSection.style.display = 'none';
            
            // Print
            window.print();
            
            // Show action buttons again after print dialog
            setTimeout(() => {
                actionsSection.style.display = 'flex';
            }, 100);
        }

        function saveReport() {
            // Create comprehensive report data
            const reportData = {
                metadata: {
                    reportGeneratedOn: new Date().toISOString(),
                    systemVersion: '4-PCAM v1.0',
                    assessmentComplete: true
                },
                patient: combinedData.patient,
                assessments: {
                    agni: combinedData.agni,
                    dosha: combinedData.dosha,
                    dhatu: combinedData.dhatu,
                    srotas: combinedData.srotas
                },
                summary: {
                    agni: getAgniSummary(),
                    dosha: getDoshaSummary(),
                    dhatu: getDhatuSummary(),
                    srotas: getSrotasSummary()
                },
                recommendations: getRecommendationsList()
            };

            // Save as JSON file
            const reportJSON = JSON.stringify(reportData, null, 2);
            const blob = new Blob([reportJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const patientName = combinedData.patient.name || 'Patient';
            const date = new Date().toISOString().split('T')[0];
            a.download = `${patientName.replace(/\s+/g, '_')}_4PCAM_Complete_${date}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('Complete assessment data saved successfully!');
        }

        function resetAllData() {
            if (confirm('⚠️ Are you sure you want to delete ALL assessment data?\n\nThis will permanently remove:\n• Patient information\n• All assessment results\n• All selected symptoms\n• This report\n\nThis action cannot be undone!')) {
                // Clear all localStorage data
                localStorage.removeItem('4pcam_patient_data');
                localStorage.removeItem('4pcam_agni_data');
                localStorage.removeItem('4pcam_dosha_data');
                localStorage.removeItem('4pcam_dhatu_data');
                localStorage.removeItem('4pcam_srotas_data');
                localStorage.removeItem('4pcam_combined_data');
                localStorage.removeItem('ayurveda_assessment_autosave');

                alert('✅ All data has been reset successfully!');
                window.location.href = 'patient-info.html';
            }
        }

        // Helper functions for report data
        function getAgniSummary() {
            const agni = combinedData.agni;
            const total = (agni.vishama || 0) + (agni.tikshna || 0) + (agni.manda || 0);
            
            return {
                totalScore: total,
                maxScore: 8,
                status: total === 0 ? 'Sama Agni' : total <= 4 ? 'Mild Dusti' : total <= 6 ? 'Moderate Dusti' : 'Severe Dusti',
                dominantType: getDominantAgniType(agni),
                selectedSymptoms: Object.keys(agni.selectedSymptoms || {}).length
            };
        }

        function getDoshaSummary() {
            const dosha = combinedData.dosha;
            const vScore = dosha.vata || 0;
            const pScore = dosha.pitta || 0;
            const kScore = dosha.kapha || 0;
            
            return {
                vataScore: vScore,
                pittaScore: pScore,
                kaphaScore: kScore,
                totalScore: vScore + pScore + kScore,
                dominantDosha: getDominantDoshaType(vScore, pScore, kScore),
                selectedSymptoms: Object.values(dosha.selectedSymptoms || {}).reduce((total, symptoms) => total + symptoms.length, 0)
            };
        }

        function getDhatuSummary() {
            const dhatu = combinedData.dhatu;
            const scores = dhatu.scores || {};
            
            let totalKshaya = 0;
            let totalVriddhi = 0;
            let affectedDhatus = 0;
            
            Object.keys(scores).forEach(d => {
                const kshaya = scores[d].kshaya || 0;
                const vriddhi = scores[d].vriddhi || 0;
                totalKshaya += kshaya;
                totalVriddhi += vriddhi;
                if (kshaya > 0 || vriddhi > 0) affectedDhatus++;
            });
            
            return {
                totalKshaya,
                totalVriddhi,
                totalScore: totalKshaya + totalVriddhi,
                affectedDhatus,
                totalDhatus: 7,
                selectedSymptoms: Object.values(dhatu.selectedSymptoms || {}).reduce((total, d) => 
                    total + (d.kshaya ? d.kshaya.length : 0) + (d.vriddhi ? d.vriddhi.length : 0), 0)
            };
        }

        function getSrotasSummary() {
            const srotas = combinedData.srotas;
            const scores = srotas.scores || {};
            const totalScore = Object.values(scores).reduce((total, score) => total + score, 0);
            const affectedSrotas = Object.keys(scores).filter(s => scores[s] > 0).length;
            
            return {
                totalScore,
                affectedSrotas,
                totalSrotas: 9,
                selectedSymptoms: Object.values(srotas.selectedSymptoms || {}).reduce((total, symptoms) => total + symptoms.length, 0)
            };
        }

        function getRecommendationsList() {
            // Return the current recommendations from the page
            const recommendationElements = document.querySelectorAll('.recommendation-item');
            return Array.from(recommendationElements).map(el => el.textContent);
        }

        function getDominantAgniType(agni) {
            const types = ['vishama', 'tikshna', 'manda', 'sama'];
            let maxScore = 0;
            let dominant = 'balanced';
            
            types.forEach(type => {
                if ((agni[type] || 0) > maxScore) {
                    maxScore = agni[type];
                    dominant = type;
                }
            });
            
            return dominant;
        }

        function getDominantDoshaType(vata, pitta, kapha) {
            const max = Math.max(vata, pitta, kapha);
            if (max === 0) return 'balanced';
            if (max === vata) return 'vata';
            if (max === pitta) return 'pitta';
            return 'kapha';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printReport();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveReport();
            }
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportToPDF();
            }
        });

        console.log("✅ Final Assessment Report System loaded successfully!");
        console.log("📊 Report generated for:", combinedData.patient?.name || 'Unknown Patient');
    </script>
</body>
</html>
